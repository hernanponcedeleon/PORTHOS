Thread 0
While (True)
  a <- 1;
  x := a;
  mfence;
  chk <- y;
  While (chk != 0)
    chk <- y;
  a <- 0;
  x := a

Thread 1
While (True)
  chk <- x;
  While (chk != 0)
    chk <- x;
  b <- 1;
  y := b;
  mfence;
  chk <- x;
  b <- 0;
  if (chk == 0)
    y := b
  else
    y := b
